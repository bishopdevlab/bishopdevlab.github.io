제작 응용 서버편

1. NCP (Naver Cloud Platform) 가입 및 서버 생성
 - Micro(1vCPU, 1GB Mem, 50GB Disk, ubuntu-16) 1년간 무료
 - 공인IP 설정(월 4~5천원 유료), ACG(방화벽) - 포트포워딩 (SSH 접속 포트:  2000)

2. 서버 접속
 - putty를 사용하여 서버 접속용 공인 IP : 101.101.160.190, 외부 포트 : 2000 접속

3. Node.js 설치
- 이후 사용되는 명령어들은 Ubuntu-16 기준입니다.
- 본 과정은 처음에는 root로 진행하다가 7번에서 사용자 계정을 추가하여 이후 사용자 계정으로 진행합니다.
root로 접속/변경 후 진행(sudo -i)

* 최신버전 정보를 curl로 다운로드
(root)
> curl -sL https://deb.nodesource.com/setup_10.x | bash -
(user)
> curl -sL https://deb.nodesource.com/setup_10.x | sudo bash -

* node.js 설치
> apt-get install -y nodejs
(-y는 질문에 yes로 자동 대답)


* node.js 설치 확인
> node -v
v10.19.0
> npm -v
6.13.4

4. Git 설치
* 버전 확인
> git --version
git version 2.7.4
> apt list git -a
Listing... Done
git/xenial-updates,xenial-security,now 1:2.7.4-0ubuntu1.7 amd64 [installed]
git/xenial 1:2.7.4-0ubuntu1 amd64

* 최신버전 설치
> add-apt-repository ppa:git-core/ppa -y
> apt update
> apt install git -y
> git --version
git version 2.26.0


5. 서비스 디렉터(/var/www) 생성
> mkdir /var/www
> cd /var/www

6. 깃허브 연결하기
* 깃허브에 서버의 ssh 키 등록
github.com > personal setting > SSH and GPG keys > Add new SSH keys

* Key 생성
> ssh-keygen -t rsa -b 4096 -C "dbjavapia@gmail.com"
질문에 Enter 입력(3회) 후 키 생성됨
> cat ~/.ssh/id_rsa.pub
키값을 복사 > 깃허브 Key 입력에 붙여넣음 > Add SSH Key 버튼 > 깃허브 비밀번호 확인

* 깃허브 소스 복제
깃허브 레파지토리 > Clone or download > Use SSH > SSH key 복사
> cd /var/www
> git clone git@github.com:bishopdevlab/solarmon.git
> cd solarmon

7. 계정 추가
- 리눅스에서 root를 그대로 사용하는 것은 아무래도 위험합니다. 따라서 사용자 계정을 추가합니다.
이후는 bishop 계정을 사용합니다.
> adduser bishop (계정 추가)
> adduser bishop sudo (관리자 권한 부여)
 - 만일 yarn으로 패키지 설치 시 EACCES: permission denied 에러가 나는 경우 디렉터리 소유자를 체크합니다.

8. www 디렉터리 소유자 변경
> cd /var
> sudo chown -R bishop www/


32. 클라우드 서버 디비 설치 및 테스트


9. yarn 설치
* yarn: Facebook이 만든 자바스크립트 패키지 매니저
* 설치 방법:  https://classic.yarnpkg.com/en/docs/install#debian-stable
> curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
> echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
deb https://dl.yarnpkg.com/debian/ stable main
> sudo apt update && sudo apt install yarn
> yarn -v
1.22.4

10. 백엔드 서버 패키지 설치
> cd /var/www/solarmon/be
> yarn (package.json 종속요소들 설치(Express.js, cors 등)

11. 프론트엔드 서버 패키지 설치
> cd /var/www/solarmon/fe
> yarn (package.json 종속요소들 설치(Express.js, cors 등)
> yarn build (정적인 파일 생성)

12. 서버 구동
> cd /var/www/solarmon/be
> npm start

13. 리눅스 패키지 업데이트
* 클라우드 서버에서 커널을 제외한 리눅스 패키지 업데이트
https://www.bonusbits.com/wiki/HowTo:Upgrade_Ubuntu_without_Updating_the_Kernel
> sudo apt-mark hold linux-image-generic linux-headers-generic
linux-image-generic set on hold.
linux-headers-generic set on hold.

14. 몽고디비 설치
root 권한으로 설치(무관한듯 하나 혹시나)
* https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/ 매뉴얼을 따라 설치함
1. Import the public key used by the package management system.
> wget -qO - https://www.mongodb.org/static/pgp/server-4.2.asc | sudo apt-key add -
> sudo apt-get install gnupg
> wget -qO - https://www.mongodb.org/static/pgp/server-4.2.asc | sudo apt-key add -
2. Create a list file for MongoDB.
- Ubuntu 16.04 (Xenial) 탭 선택
> echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/4.2 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.2.list
3. Reload local package database
> sudo apt-get update
4. Install the MongoDB packages.
> sudo apt-get install -y mongodb-org

설치정보 매뉴얼 설명:
data directory /var/lib/mongodb
log directory /var/log/mongodb
By default, MongoDB runs using the mongodb user account. If you change the user that runs the MongoDB process, you must also modify the permission to the data and log directories to give this user access to these directories.
configuration file /etc/mongod.conf

5. Run MongoDB
* 설치된 리눅스가 systemd(systemctl 명령어)를 사용하는지 System V init(service 명령어)를 사용해야 하는지, 아래 명령어로 확인할 수 있다.
> ps --no-headers -o comm 1
systemd

6. Start/Stop MongoDB
* Start
> sudo systemctl start mongod
* Status
> sudo systemctl status mongod
* Stop
> sudo systemctl stop mongod
* Restart
> sudo systemctl restart mongod

7. DB 확인
* MongoDB 쉘 실행 및 DB 확인
> mongo
> show dbs;
* DB 생성 후 데이터 추가
> use solarmon;
> db.test.insertOne({a:1});
> show dbs;
> exit

* 리눅스 시작 시 MongoDB 서비스 실행하기
> systemctl enable mongod.service

8. 포트 3000 열어주기
NCP 네이버 클라우드 플랫폼 (https://console.ncloud.com/) 접속 후 ACG 설정에서 TCP, 0.0.0.0/0(전체), 3000 포트를 열어줌

9. be 실행
> cd /var/www/solarmon/be
> npm start

10. 에러 해결
로컬 PC에서 github에서 소스를 clone 후 "10. 백엔드 서버 패키지 설치"부터 "12. 서버 구동"까지 진행하여 에러를 확인함

/var/www/solarmon/fe/src/views/user.vue
- console.log 주석 처리 (// console.log~~)
- http://localhost:3000/를 상대경로(/)로 변경

http://localhost:3000/ 접속 확인

* 변경코드 github에 push

10. 서버에서 변경 사항 받기
> cd /var/www/solarmon/
> git pull
> cd fe
> yarn build (갱신된 소스 빌드)
> cd ../be
> npm start




